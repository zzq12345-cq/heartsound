{
  "id": "IMPL-005",
  "title": "微信小程序用户端 - 检测流程四步骤",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "phase": 3,
    "estimated_effort": "3天"
  },
  "context": {
    "requirements": [
      "实现4个检测流程页面: [prepare准备页, recording录制页, analyzing分析中页, result结果页]",
      "创建2个核心组件: [waveform波形显示组件(Canvas), loading-heart心跳加载动画组件]",
      "实现1个检测服务: services/detection.js (包含WebSocket连接管理)",
      "创建1个结果卡片组件: components/result-card (3种风险颜色)",
      "实现Canvas波形渲染>=30fps",
      "实现30秒倒计时准确计时"
    ],
    "focus_paths": [
      "miniprogram/pages/detection/",
      "miniprogram/components/waveform/",
      "miniprogram/components/loading-heart/",
      "miniprogram/components/result-card/",
      "miniprogram/services/detection.js"
    ],
    "acceptance": [
      "4个检测页面可正常跳转: verify by navigateTo/redirectTo链式跳转成功",
      "Canvas波形渲染>=30fps: verify by 使用wx.createSelectorQuery测量帧率",
      "WebSocket连接建立<=2秒: verify by console.log显示连接时间",
      "倒计时30秒准确: verify by 录制结束时间与开始时间差=30秒",
      "3种风险结果正确显示: verify by 切换风险等级UI颜色正确切换",
      "结果页保存功能可用: verify by 点击保存后Supabase记录新增"
    ],
    "depends_on": ["IMPL-003", "IMPL-004"],
    "artifacts": [
      {
        "type": "design_document",
        "path": "心音智鉴检测中心功能设计方案.md",
        "section": "二、检测中心模块 - 检测流程总览 至 五、结果展示页",
        "priority": "highest"
      }
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_detection_design",
        "action": "读取检测流程设计规范",
        "commands": ["Read(心音智鉴检测中心功能设计方案.md)"],
        "output_to": "detection_design_spec",
        "on_error": "abort"
      },
      {
        "step": "mcp_canvas_patterns",
        "action": "获取小程序Canvas波形绘制最佳实践",
        "command": "mcp__exa__get_code_context_exa(query='微信小程序 Canvas 实时波形绘制 高性能')",
        "output_to": "canvas_patterns",
        "on_error": "skip_optional"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "实现检测服务模块",
        "description": "封装WebSocket连接和检测流程管理",
        "modification_points": [
          "创建1个检测服务: services/detection.js (约200行)",
          "实现6个方法: [startDetection(), stopDetection(), connectWebSocket(), onAudioFrame(), onStatusUpdate(), getResult()]"
        ],
        "logic_flow": [
          "调用后端/api/detection/start获取session_id",
          "建立WebSocket连接",
          "监听音频帧和状态消息",
          "管理检测会话状态",
          "获取并缓存检测结果"
        ],
        "depends_on": [],
        "output": "detection_service"
      },
      {
        "step": 2,
        "title": "创建波形显示组件",
        "description": "使用Canvas实现实时波形渲染",
        "modification_points": [
          "创建1个组件目录: components/waveform/",
          "创建4个组件文件: [index.js约150行, index.json, index.wxml, index.wxss]",
          "实现Canvas 2D绑定和requestAnimationFrame渲染循环"
        ],
        "logic_flow": [
          "初始化Canvas 2D上下文",
          "接收音频数据数组",
          "使用requestAnimationFrame循环绘制",
          "绘制波形线条和中心参考线",
          "保持30fps刷新率"
        ],
        "depends_on": [],
        "output": "waveform_component"
      },
      {
        "step": 3,
        "title": "创建心跳加载动画组件",
        "description": "实现分析中页面的心跳动画",
        "modification_points": [
          "创建1个组件目录: components/loading-heart/",
          "创建4个组件文件",
          "使用CSS动画或Lottie实现心跳脉冲效果"
        ],
        "logic_flow": [
          "定义心形图标缩放动画",
          "设置800ms动画周期",
          "添加波形流动效果"
        ],
        "depends_on": [],
        "output": "loading_heart_component"
      },
      {
        "step": 4,
        "title": "实现检测准备页",
        "description": "开发听诊器放置引导页面",
        "modification_points": [
          "创建1个页面目录: pages/detection/prepare/",
          "创建4个页面文件",
          "显示心脏位置示意图和引导文案"
        ],
        "logic_flow": [
          "展示检测引导图片",
          "显示准备步骤说明",
          "点击开始跳转录制页"
        ],
        "depends_on": [],
        "output": "prepare_page"
      },
      {
        "step": 5,
        "title": "实现录制页面",
        "description": "开发30秒心音采集页面",
        "modification_points": [
          "创建1个页面目录: pages/detection/recording/",
          "创建4个页面文件: [index.js约180行, index.json, index.wxml约60行, index.wxss约80行]",
          "集成waveform组件和倒计时逻辑"
        ],
        "logic_flow": [
          "页面加载启动检测服务",
          "建立WebSocket连接",
          "接收音频帧更新波形",
          "显示30秒倒计时",
          "倒计时结束跳转分析页"
        ],
        "depends_on": [1, 2],
        "output": "recording_page"
      },
      {
        "step": 6,
        "title": "实现分析中页面",
        "description": "开发AI推理等待页面",
        "modification_points": [
          "创建1个页面目录: pages/detection/analyzing/",
          "创建4个页面文件",
          "集成loading-heart组件"
        ],
        "logic_flow": [
          "显示心跳加载动画",
          "轮询检测结果状态",
          "结果就绪跳转结果页"
        ],
        "depends_on": [1, 3],
        "output": "analyzing_page"
      },
      {
        "step": 7,
        "title": "创建结果卡片组件",
        "description": "实现三种风险等级的结果展示",
        "modification_points": [
          "创建1个组件目录: components/result-card/",
          "创建4个组件文件",
          "实现3种风险颜色样式: [safe绿色, warning黄色, danger红色]"
        ],
        "logic_flow": [
          "根据risk_level属性渲染不同样式",
          "显示检测结果和置信度",
          "展示概率分布表格"
        ],
        "depends_on": [],
        "output": "result_card_component"
      },
      {
        "step": 8,
        "title": "实现结果展示页",
        "description": "开发检测结果和健康建议页面",
        "modification_points": [
          "创建1个页面目录: pages/detection/result/",
          "创建4个页面文件: [index.js约200行, index.json, index.wxml约120行, index.wxss约150行]",
          "集成result-card组件和健康建议展示"
        ],
        "logic_flow": [
          "获取检测结果数据",
          "渲染结果卡片(大字状态+颜色)",
          "显示详细概率表格",
          "展示健康建议列表",
          "提供保存和再次检测按钮"
        ],
        "depends_on": [1, 7],
        "output": "result_page"
      }
    ],
    "target_files": [
      "miniprogram/services/detection.js",
      "miniprogram/components/waveform/index.js",
      "miniprogram/components/waveform/index.wxml",
      "miniprogram/components/loading-heart/index.js",
      "miniprogram/components/loading-heart/index.wxml",
      "miniprogram/components/result-card/index.js",
      "miniprogram/components/result-card/index.wxml",
      "miniprogram/pages/detection/prepare/index.js",
      "miniprogram/pages/detection/prepare/index.wxml",
      "miniprogram/pages/detection/recording/index.js",
      "miniprogram/pages/detection/recording/index.wxml",
      "miniprogram/pages/detection/analyzing/index.js",
      "miniprogram/pages/detection/analyzing/index.wxml",
      "miniprogram/pages/detection/result/index.js",
      "miniprogram/pages/detection/result/index.wxml"
    ]
  }
}
