{
  "id": "IMPL-001",
  "title": "Supabase数据库配置与初始化",
  "status": "completed",
  "meta": {
    "type": "infrastructure",
    "agent": "@code-developer",
    "phase": 1,
    "estimated_effort": "1-2天"
  },
  "context": {
    "requirements": [
      "创建1个Supabase项目: [heartsound-db]",
      "创建9个数据表: [users, devices, user_devices, detection_records, health_tips, admins, admin_logs, ai_reports, report_tasks]",
      "配置8条RLS策略: [users SELECT/UPDATE, detection_records SELECT/INSERT, user_devices SELECT, health_tips SELECT, admins SELECT, admin_logs INSERT, ai_reports SELECT/INSERT, report_tasks SELECT/INSERT]",
      "插入4条健康小贴士初始数据: [心率范围, 规律作息, 适度运动, 戒烟限酒]",
      "创建5个数据库索引: [idx_users_openid, idx_user_devices_user, idx_records_user, idx_records_created, idx_records_risk]"
    ],
    "focus_paths": [
      "supabase/",
      "supabase/migrations/",
      "supabase/seed.sql"
    ],
    "acceptance": [
      "9个数据表已创建: verify by Supabase Dashboard显示所有表",
      "8条RLS策略已启用: verify by Supabase Dashboard的Authentication > Policies",
      "4条初始数据已插入: verify by SELECT count(*) FROM health_tips = 4",
      "5个索引已创建: verify by \\di命令显示所有索引"
    ],
    "depends_on": [],
    "artifacts": [
      {
        "type": "design_document",
        "path": "心音智鉴检测中心功能设计方案.md",
        "section": "十一、数据库设计（Supabase）",
        "priority": "highest"
      }
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_design_document",
        "action": "读取数据库设计章节",
        "commands": ["Read(心音智鉴检测中心功能设计方案.md)"],
        "output_to": "database_design_spec",
        "on_error": "abort"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "创建Supabase项目和本地配置",
        "description": "初始化Supabase项目结构和配置文件",
        "modification_points": [
          "创建1个目录结构: supabase/",
          "创建2个配置文件: [supabase/config.toml, supabase/.env.example]"
        ],
        "logic_flow": [
          "初始化supabase目录结构",
          "创建配置文件模板",
          "配置项目环境变量"
        ],
        "depends_on": [],
        "output": "supabase_project_structure"
      },
      {
        "step": 2,
        "title": "编写数据库迁移脚本",
        "description": "创建9个数据表的SQL迁移脚本",
        "modification_points": [
          "创建1个迁移文件: supabase/migrations/001_initial_schema.sql (约200行SQL)",
          "定义9个CREATE TABLE语句",
          "定义5个CREATE INDEX语句"
        ],
        "logic_flow": [
          "按设计文档顺序创建表结构",
          "添加外键约束",
          "创建必要索引"
        ],
        "depends_on": [1],
        "output": "migration_sql"
      },
      {
        "step": 3,
        "title": "配置Row Level Security策略",
        "description": "为敏感数据表创建RLS策略",
        "modification_points": [
          "创建1个RLS策略文件: supabase/migrations/002_rls_policies.sql (约100行SQL)",
          "启用4个表的RLS: [users, detection_records, user_devices, health_tips]",
          "创建8条安全策略"
        ],
        "logic_flow": [
          "为每个敏感表启用RLS",
          "创建基于auth.uid()的访问策略",
          "配置公开可读的health_tips策略"
        ],
        "depends_on": [2],
        "output": "rls_policies"
      },
      {
        "step": 4,
        "title": "创建种子数据",
        "description": "插入健康小贴士等初始数据",
        "modification_points": [
          "创建1个种子文件: supabase/seed.sql (约30行SQL)",
          "插入4条health_tips数据"
        ],
        "logic_flow": [
          "准备初始健康小贴士数据",
          "执行INSERT语句"
        ],
        "depends_on": [2],
        "output": "seed_data"
      }
    ],
    "target_files": [
      "supabase/config.toml",
      "supabase/.env.example",
      "supabase/migrations/001_initial_schema.sql",
      "supabase/migrations/002_rls_policies.sql",
      "supabase/seed.sql"
    ]
  }
}
