{
  "id": "IMPL-006",
  "title": "微信小程序用户端 - 健康档案和AI助手",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "phase": 3,
    "estimated_effort": "2天"
  },
  "context": {
    "requirements": [
      "实现3个档案相关页面: [records历史记录列表, record-detail记录详情, profile个人中心]",
      "实现2个AI助手页面: [ai-assistant/chat对话页, ai-assistant/report智能报告页]",
      "创建1个Dify服务: services/dify.js (包含Chatflow和Workflow调用)",
      "创建2个AI组件: [chat-bubble对话气泡, report-card报告卡片]",
      "实现1个记录服务: services/record.js (CRUD操作)"
    ],
    "focus_paths": [
      "miniprogram/pages/records/",
      "miniprogram/pages/ai-assistant/",
      "miniprogram/pages/profile/",
      "miniprogram/services/",
      "miniprogram/components/"
    ],
    "acceptance": [
      "历史记录列表分页加载: verify by 滚动到底部触发加载更多",
      "记录详情展示完整: verify by 页面显示所有检测数据字段",
      "AI对话响应<=5秒: verify by 发送消息后5秒内显示回复",
      "智能报告生成<=10秒: verify by 点击生成后10秒内显示报告",
      "所有AI回复包含免责声明: verify by 回复末尾显示警告提示",
      "Supabase数据同步成功: verify by 记录保存后刷新列表可见"
    ],
    "depends_on": ["IMPL-005"],
    "artifacts": [
      {
        "type": "design_document",
        "path": "心音智鉴检测中心功能设计方案.md",
        "section": "十五、AI健康助手模块",
        "priority": "highest"
      }
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_ai_assistant_design",
        "action": "读取AI健康助手设计规范",
        "commands": ["Read(心音智鉴检测中心功能设计方案.md)"],
        "output_to": "ai_assistant_design_spec",
        "on_error": "abort"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "实现记录服务模块",
        "description": "封装检测记录的CRUD操作",
        "modification_points": [
          "创建1个记录服务: services/record.js (约100行)",
          "实现4个方法: [saveRecord(), getRecords(), getRecordById(), deleteRecord()]"
        ],
        "logic_flow": [
          "调用Supabase插入检测记录",
          "分页查询历史记录",
          "获取单条记录详情",
          "软删除或硬删除记录"
        ],
        "depends_on": [],
        "output": "record_service"
      },
      {
        "step": 2,
        "title": "实现历史记录页面",
        "description": "开发检测记录列表页面",
        "modification_points": [
          "创建1个页面目录: pages/records/",
          "创建4个页面文件: [index.js约120行, index.json, index.wxml约80行, index.wxss约60行]",
          "实现分页加载和下拉刷新"
        ],
        "logic_flow": [
          "页面加载获取最近20条记录",
          "显示记录卡片列表",
          "点击卡片跳转详情页",
          "滚动到底加载更多"
        ],
        "depends_on": [1],
        "output": "records_page"
      },
      {
        "step": 3,
        "title": "实现Dify服务模块",
        "description": "封装Dify API调用",
        "modification_points": [
          "创建1个Dify服务: services/dify.js (约150行)",
          "实现3个方法: [sendChatMessage(), streamChatMessage(), generateHealthReport()]",
          "配置API Key和Base URL"
        ],
        "logic_flow": [
          "封装chat-messages API调用",
          "处理blocking和streaming响应模式",
          "封装workflows/run API调用",
          "解析Workflow输出的报告JSON"
        ],
        "depends_on": [],
        "output": "dify_service"
      },
      {
        "step": 4,
        "title": "创建对话气泡组件",
        "description": "实现AI对话的消息气泡UI",
        "modification_points": [
          "创建1个组件目录: components/chat-bubble/",
          "创建4个组件文件",
          "实现2种气泡样式: [用户消息右侧, AI消息左侧]"
        ],
        "logic_flow": [
          "根据role属性渲染不同位置",
          "用户消息蓝色背景靠右",
          "AI消息灰色背景靠左带头像"
        ],
        "depends_on": [],
        "output": "chat_bubble_component"
      },
      {
        "step": 5,
        "title": "实现AI对话页面",
        "description": "开发健康问答对话界面",
        "modification_points": [
          "创建1个页面目录: pages/ai-assistant/chat/",
          "创建4个页面文件: [index.js约180行, index.json, index.wxml约100行, index.wxss约80行]",
          "集成chat-bubble组件和输入框"
        ],
        "logic_flow": [
          "显示欢迎消息",
          "用户输入问题发送",
          "调用Dify API获取回复",
          "支持流式输出打字机效果",
          "显示快捷问题按钮"
        ],
        "depends_on": [3, 4],
        "output": "chat_page"
      },
      {
        "step": 6,
        "title": "创建报告卡片组件",
        "description": "实现智能报告的展示卡片",
        "modification_points": [
          "创建1个组件目录: components/report-card/",
          "创建4个组件文件",
          "展示总体评估/数据统计/健康建议"
        ],
        "logic_flow": [
          "解析报告JSON数据",
          "渲染统计数据区块",
          "显示建议列表"
        ],
        "depends_on": [],
        "output": "report_card_component"
      },
      {
        "step": 7,
        "title": "实现智能报告页面",
        "description": "开发AI健康报告生成页面",
        "modification_points": [
          "创建1个页面目录: pages/ai-assistant/report/",
          "创建4个页面文件: [index.js约150行, index.json, index.wxml约120行, index.wxss约100行]",
          "集成report-card组件"
        ],
        "logic_flow": [
          "点击生成按钮",
          "调用Dify Workflow API",
          "显示生成进度",
          "渲染报告内容",
          "支持分享和导出"
        ],
        "depends_on": [3, 6],
        "output": "report_page"
      },
      {
        "step": 8,
        "title": "实现个人中心页面",
        "description": "开发用户个人信息和设置页面",
        "modification_points": [
          "创建1个页面目录: pages/profile/",
          "创建4个页面文件",
          "显示用户信息/绑定设备/设置选项"
        ],
        "logic_flow": [
          "显示用户头像和昵称",
          "显示已绑定设备",
          "提供设置入口",
          "支持退出登录"
        ],
        "depends_on": [],
        "output": "profile_page"
      }
    ],
    "target_files": [
      "miniprogram/services/record.js",
      "miniprogram/services/dify.js",
      "miniprogram/components/chat-bubble/index.js",
      "miniprogram/components/chat-bubble/index.wxml",
      "miniprogram/components/report-card/index.js",
      "miniprogram/components/report-card/index.wxml",
      "miniprogram/pages/records/index.js",
      "miniprogram/pages/records/index.wxml",
      "miniprogram/pages/ai-assistant/chat/index.js",
      "miniprogram/pages/ai-assistant/chat/index.wxml",
      "miniprogram/pages/ai-assistant/report/index.js",
      "miniprogram/pages/ai-assistant/report/index.wxml",
      "miniprogram/pages/profile/index.js",
      "miniprogram/pages/profile/index.wxml"
    ]
  }
}
