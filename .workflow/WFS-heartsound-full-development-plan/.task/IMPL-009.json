{
  "id": "IMPL-009",
  "title": "管理后台小程序 - 报表导出功能",
  "status": "completed",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "phase": 4,
    "estimated_effort": "1天"
  },
  "context": {
    "requirements": [
      "实现2个报表页面: [reports/export报表导出页, reports/history历史报表页]",
      "支持4种报表类型: [detection_data检测数据, user_stats用户统计, device_usage设备使用, risk_analysis风险分析]",
      "支持2种导出格式: [Excel(.xlsx), CSV]",
      "实现1个报表服务: services/report.js (生成/查询/下载)",
      "支持后台异步生成: 大报表不阻塞用户操作"
    ],
    "focus_paths": [
      "miniprogram-admin/pages/reports/",
      "miniprogram-admin/services/report.js"
    ],
    "acceptance": [
      "4种报表类型可选择: verify by 页面显示4个单选项",
      "时间范围选择可用: verify by 日期选择器可选开始/结束日期",
      "快捷选择今天/本周/本月: verify by 点击按钮自动填充日期",
      "报表生成后台处理: verify by 点击生成后页面可继续操作",
      "历史报表列表显示: verify by 页面显示已生成的报表及下载链接",
      "报表7天后自动过期: verify by expires_at字段为创建时间+7天"
    ],
    "depends_on": ["IMPL-008"],
    "artifacts": [
      {
        "type": "design_document",
        "path": "心音智鉴检测中心功能设计方案.md",
        "section": "十四、管理员后台模块 - 14.6报表导出",
        "priority": "highest"
      }
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_report_design",
        "action": "读取报表导出设计规范",
        "commands": ["Read(心音智鉴检测中心功能设计方案.md)"],
        "output_to": "report_design_spec",
        "on_error": "abort"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "实现报表服务模块",
        "description": "封装报表生成和下载API调用",
        "modification_points": [
          "创建1个报表服务: services/report.js (约100行)",
          "实现4个方法: [generateReport(), getReportStatus(), getReportHistory(), downloadReport()]"
        ],
        "logic_flow": [
          "提交报表生成任务",
          "轮询任务状态",
          "获取历史报表列表",
          "获取下载链接"
        ],
        "depends_on": [],
        "output": "report_service"
      },
      {
        "step": 2,
        "title": "实现报表导出页面",
        "description": "开发报表类型选择和生成页面",
        "modification_points": [
          "创建1个页面目录: pages/reports/export/",
          "创建4个页面文件: [index.js约150行, index.json, index.wxml约120行, index.wxss约80行]",
          "实现报表类型单选/日期范围选择/格式选择"
        ],
        "logic_flow": [
          "选择报表类型(4选1)",
          "选择时间范围(快捷或自定义)",
          "选择导出格式",
          "点击生成提交任务",
          "显示生成进度",
          "生成完成提供下载"
        ],
        "depends_on": [1],
        "output": "export_page"
      },
      {
        "step": 3,
        "title": "实现历史报表页面",
        "description": "开发已生成报表的历史列表",
        "modification_points": [
          "创建1个页面目录: pages/reports/history/",
          "创建4个页面文件",
          "显示报表名称/类型/大小/过期时间/下载按钮"
        ],
        "logic_flow": [
          "加载历史报表列表",
          "显示报表元信息",
          "点击下载获取文件",
          "已过期报表灰显不可下载"
        ],
        "depends_on": [1],
        "output": "history_page"
      },
      {
        "step": 4,
        "title": "实现报表生成后端逻辑(Supabase Edge Function)",
        "description": "创建Edge Function处理报表生成",
        "modification_points": [
          "创建1个Edge Function: supabase/functions/generate-report/",
          "实现4种报表的数据查询和Excel生成",
          "上传生成的文件到Supabase Storage"
        ],
        "logic_flow": [
          "接收报表参数",
          "查询对应时间段数据",
          "生成Excel/CSV文件",
          "上传到Storage",
          "更新report_tasks状态"
        ],
        "depends_on": [],
        "output": "edge_function"
      }
    ],
    "target_files": [
      "miniprogram-admin/services/report.js",
      "miniprogram-admin/pages/reports/export/index.js",
      "miniprogram-admin/pages/reports/export/index.wxml",
      "miniprogram-admin/pages/reports/export/index.wxss",
      "miniprogram-admin/pages/reports/history/index.js",
      "miniprogram-admin/pages/reports/history/index.wxml",
      "supabase/functions/generate-report/index.ts"
    ]
  }
}
